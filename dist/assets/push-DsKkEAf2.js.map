{"version":3,"file":"push-DsKkEAf2.js","names":["subData: PushSubscriptionData"],"sources":["../../src/services/push.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase/client'\nimport { PushSubscriptionData } from '@/types'\n\nconst VAPID_PUBLIC_KEY = import.meta.env.VITE_VAPID_PUBLIC_KEY\n\nexport const registerPush = async () => {\n  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {\n    throw new Error('Push notifications are not supported by your browser')\n  }\n\n  if (!VAPID_PUBLIC_KEY) {\n    throw new Error('VAPID Public Key is missing in environment variables')\n  }\n\n  const registration = await navigator.serviceWorker.ready\n  let subscription = await registration.pushManager.getSubscription()\n\n  if (!subscription) {\n    subscription = await registration.pushManager.subscribe({\n      userVisibleOnly: true,\n      applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),\n    })\n  }\n\n  await saveSubscription(subscription)\n  return subscription\n}\n\nexport const unsubscribePush = async () => {\n  const registration = await navigator.serviceWorker.ready\n  const subscription = await registration.pushManager.getSubscription()\n\n  if (subscription) {\n    await subscription.unsubscribe()\n    // Remove from DB\n    // We match by endpoint usually\n    const { error } = await supabase\n      .from('push_subscriptions')\n      .delete()\n      .eq('endpoint', subscription.endpoint)\n\n    if (error) console.error('Error removing subscription from DB', error)\n  }\n}\n\nexport const checkSubscription = async () => {\n  if (!('serviceWorker' in navigator)) return false\n  const registration = await navigator.serviceWorker.ready\n  const subscription = await registration.pushManager.getSubscription()\n  return !!subscription\n}\n\nconst saveSubscription = async (subscription: PushSubscription) => {\n  const subData: PushSubscriptionData = JSON.parse(JSON.stringify(subscription))\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) throw new Error('User not authenticated')\n\n  const { error } = await supabase.from('push_subscriptions').upsert(\n    {\n      user_id: user.id,\n      endpoint: subData.endpoint,\n      keys: subData.keys,\n    },\n    { onConflict: 'user_id, endpoint' },\n  )\n\n  if (error) throw error\n}\n\nfunction urlBase64ToUint8Array(base64String: string) {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4)\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')\n\n  const rawData = window.atob(base64)\n  const outputArray = new Uint8Array(rawData.length)\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i)\n  }\n  return outputArray\n}\n\nexport const sendPushNotification = async (\n  title: string,\n  body: string,\n  url?: string,\n) => {\n  const { error } = await supabase.functions.invoke('send-push', {\n    body: { title, body, url },\n  })\n  return { error }\n}\n"],"mappings":";AAKA,MAAa,eAAe,YAAY;AACtC,KAAI,EAAE,mBAAmB,cAAc,EAAE,iBAAiB,QACxD,OAAM,IAAI,MAAM,uDAAuD;AAIvE,OAAM,IAAI,MAAM,uDAAuD;;AAiB3E,MAAa,kBAAkB,YAAY;CAEzC,MAAM,eAAe,OADA,MAAM,UAAU,cAAc,OACX,YAAY,iBAAiB;AAErE,KAAI,cAAc;AAChB,QAAM,aAAa,aAAa;EAGhC,MAAM,EAAE,UAAU,MAAM,SACrB,KAAK,qBAAqB,CAC1B,QAAQ,CACR,GAAG,YAAY,aAAa,SAAS;AAExC,MAAI,MAAO,SAAQ,MAAM,uCAAuC,MAAM;;;AAI1E,MAAa,oBAAoB,YAAY;AAC3C,KAAI,EAAE,mBAAmB,WAAY,QAAO;AAG5C,QAAO,CAAC,CADa,OADA,MAAM,UAAU,cAAc,OACX,YAAY,iBAAiB;;AAqCvE,MAAa,uBAAuB,OAClC,OACA,MACA,QACG;CACH,MAAM,EAAE,UAAU,MAAM,SAAS,UAAU,OAAO,aAAa,EAC7D,MAAM;EAAE;EAAO;EAAM;EAAK,EAC3B,CAAC;AACF,QAAO,EAAE,OAAO"}