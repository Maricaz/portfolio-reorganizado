{"version":3,"file":"AdminLogin-22-x_ya6.js","names":["error: any"],"sources":["../../src/pages/admin/AdminLogin.tsx"],"sourcesContent":["import { useState, useEffect } from 'react'\nimport { useAuth } from '@/hooks/use-auth'\nimport { useNavigate } from 'react-router-dom'\nimport { Button } from '@/components/ui/button'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport {\n  Card,\n  CardContent,\n  CardHeader,\n  CardTitle,\n  CardDescription,\n} from '@/components/ui/card'\nimport { useToast } from '@/hooks/use-toast'\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from '@/components/ui/dialog'\nimport { supabase } from '@/lib/supabase/client'\nimport { ShieldAlert, Loader2 } from 'lucide-react'\n\nexport default function AdminLogin() {\n  const [email, setEmail] = useState('')\n  const [password, setPassword] = useState('')\n  const [loading, setLoading] = useState(false)\n  const [resetEmail, setResetEmail] = useState('')\n  const [isResetOpen, setIsResetOpen] = useState(false)\n\n  // MFA State\n  const [mfaRequired, setMfaRequired] = useState(false)\n  const [mfaCode, setMfaCode] = useState('')\n  const [factorId, setFactorId] = useState<string | null>(null)\n\n  const { signIn, resetPassword, verifyMfa, user, role, signOut } = useAuth()\n  const navigate = useNavigate()\n  const { toast } = useToast()\n\n  // Redirect if already logged in and has correct role\n  useEffect(() => {\n    if (user && role) {\n      const allowedRoles = ['admin', 'super_admin', 'editor']\n      if (allowedRoles.includes(role)) {\n        navigate('/admin')\n      }\n    }\n  }, [user, role, navigate])\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n\n    try {\n      // 1. Basic Sign In\n      const { data, error } = await signIn(email, password)\n\n      if (error) {\n        throw new Error('Invalid credentials')\n      }\n\n      if (!data.user) {\n        throw new Error('No user returned from login')\n      }\n\n      // 2. Check User Role directly to ensure immediate feedback\n      // We do this manually here to avoid waiting for the async auth listener state update\n      const { data: profile, error: profileError } = await supabase\n        .from('profiles')\n        .select('role')\n        .eq('id', data.user.id)\n        .single()\n\n      if (profileError) {\n        await signOut()\n        throw new Error('Error verifying user profile')\n      }\n\n      const userRole = profile?.role || 'user'\n      const allowedRoles = ['admin', 'super_admin', 'editor']\n\n      if (!allowedRoles.includes(userRole)) {\n        await signOut()\n        throw new Error('Access denied: Administrator privileges required')\n      }\n\n      // 3. Check for MFA Factors\n      const { data: factorsData, error: factorsError } =\n        await supabase.auth.mfa.listFactors()\n\n      if (factorsError) {\n        // If MFA check fails, we still let them in if they are admin, or fail?\n        // Assuming fail safe, but let's just log it and proceed if no strict requirement\n        console.error('Error listing MFA factors:', factorsError)\n      }\n\n      const verifiedFactors =\n        factorsData?.all?.filter((f) => f.status === 'verified') || []\n\n      if (verifiedFactors.length > 0) {\n        // MFA Required\n        setFactorId(verifiedFactors[0].id) // Use the first verified factor\n        setMfaRequired(true)\n        setLoading(false)\n      } else {\n        // No MFA, proceed\n        setLoading(false)\n        navigate('/admin')\n      }\n    } catch (error: any) {\n      setLoading(false)\n      toast({\n        title: 'Login failed',\n        description: error.message || 'An error occurred',\n        variant: 'destructive',\n      })\n    }\n  }\n\n  const handleMfaVerify = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!factorId) return\n\n    setLoading(true)\n    const { error } = await verifyMfa(factorId, mfaCode)\n    setLoading(false)\n\n    if (error) {\n      toast({\n        title: 'MFA Verification failed',\n        description: error.message,\n        variant: 'destructive',\n      })\n    } else {\n      navigate('/admin')\n    }\n  }\n\n  const handleResetPassword = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setLoading(true)\n    const { error } = await resetPassword(resetEmail)\n    setLoading(false)\n    setIsResetOpen(false)\n\n    if (error) {\n      toast({\n        title: 'Error',\n        description: error.message,\n        variant: 'destructive',\n      })\n    } else {\n      toast({\n        title: 'Email sent',\n        description: 'Check your inbox for password reset instructions.',\n      })\n    }\n  }\n\n  if (mfaRequired) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-muted/20 p-4\">\n        <Card className=\"w-full max-w-md border-primary/20 shadow-lg\">\n          <CardHeader className=\"space-y-1\">\n            <div className=\"mx-auto w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-4\">\n              <ShieldAlert className=\"w-6 h-6 text-primary\" />\n            </div>\n            <CardTitle className=\"text-center\">\n              Two-Factor Authentication\n            </CardTitle>\n            <CardDescription className=\"text-center\">\n              Enter the code from your authenticator app\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleMfaVerify} className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"mfa-code\" className=\"sr-only\">\n                  Authentication Code\n                </Label>\n                <Input\n                  id=\"mfa-code\"\n                  type=\"text\"\n                  value={mfaCode}\n                  onChange={(e) => setMfaCode(e.target.value)}\n                  className=\"text-center text-lg tracking-widest\"\n                  placeholder=\"000000\"\n                  maxLength={6}\n                  autoFocus\n                  required\n                />\n              </div>\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={loading || mfaCode.length !== 6}\n              >\n                {loading ? 'Verifying...' : 'Verify'}\n              </Button>\n              <Button\n                variant=\"ghost\"\n                type=\"button\"\n                className=\"w-full text-xs text-muted-foreground\"\n                onClick={() => window.location.reload()}\n              >\n                Back to Login\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-muted/20 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader>\n          <CardTitle>Admin Access</CardTitle>\n          <CardDescription>\n            Enter your credentials to access the dashboard\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleLogin} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input\n                id=\"email\"\n                type=\"email\"\n                value={email}\n                onChange={(e) => setEmail(e.target.value)}\n                required\n                disabled={loading}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"password\">Password</Label>\n                <Dialog open={isResetOpen} onOpenChange={setIsResetOpen}>\n                  <DialogTrigger asChild>\n                    <Button\n                      variant=\"link\"\n                      className=\"px-0 font-normal h-auto text-xs\"\n                      type=\"button\"\n                    >\n                      Forgot password?\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent>\n                    <DialogHeader>\n                      <DialogTitle>Reset Password</DialogTitle>\n                      <DialogDescription>\n                        Enter your email address and we'll send you a link to\n                        reset your password.\n                      </DialogDescription>\n                    </DialogHeader>\n                    <form onSubmit={handleResetPassword}>\n                      <div className=\"grid gap-4 py-4\">\n                        <div className=\"grid gap-2\">\n                          <Label htmlFor=\"reset-email\">Email</Label>\n                          <Input\n                            id=\"reset-email\"\n                            type=\"email\"\n                            value={resetEmail}\n                            onChange={(e) => setResetEmail(e.target.value)}\n                            required\n                          />\n                        </div>\n                      </div>\n                      <DialogFooter>\n                        <Button type=\"submit\" disabled={loading}>\n                          {loading ? 'Sending...' : 'Send Reset Link'}\n                        </Button>\n                      </DialogFooter>\n                    </form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n              <Input\n                id=\"password\"\n                type=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                required\n                disabled={loading}\n              />\n            </div>\n            <Button type=\"submit\" className=\"w-full\" disabled={loading}>\n              {loading ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Signing in...\n                </>\n              ) : (\n                'Sign In'\n              )}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n"],"mappings":"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"}