{"version":3,"file":"security-BjG4ndZ7.js","names":[],"sources":["../../src/services/security.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase/client'\nimport { sendPushNotification } from '@/services/push'\n\nexport interface SessionInfo {\n  id: string\n  user_id: string\n  created_at: string\n  updated_at: string\n  user_agent: string\n  ip: string\n  last_sign_in_at: string\n}\n\n// Session Management\nexport const listActiveSessions = async (): Promise<SessionInfo[]> => {\n  const { data, error } = await supabase.functions.invoke('manage-sessions', {\n    method: 'GET',\n  })\n\n  if (error) throw error\n  return data.sessions || []\n}\n\nexport const revokeSession = async (sessionId: string) => {\n  const { data, error } = await supabase.functions.invoke('manage-sessions', {\n    method: 'POST',\n    body: { sessionId },\n    headers: {\n      // Passing action via query param if needed, but handled in body/method logic\n    },\n    // We append query param to URL manually in the client usually,\n    // but supabase.functions.invoke handles URL.\n    // Let's rely on the body being parsed by the function as 'revoke' if DELETE or POST with body\n  })\n\n  // Actually, the edge function expects action param or DELETE method.\n  // invoke() doesn't easily let us change the method to DELETE without some tricks or just using POST with body.\n  // Let's try passing 'action=revoke' in the options URL? No, invoke takes function name.\n  // We will update the call to be robust:\n  const { data: res, error: invokeError } = await supabase.functions.invoke(\n    'manage-sessions?action=revoke',\n    {\n      method: 'POST',\n      body: { sessionId },\n    },\n  )\n\n  if (invokeError) throw invokeError\n  return res\n}\n\n// Security Events\nexport const logSecurityEvent = async (action: string, details: any = {}) => {\n  const { error } = await supabase.rpc('log_security_activity', {\n    action_text: action,\n    details,\n  })\n\n  if (error) console.error('Failed to log security event:', error)\n  return { error }\n}\n\nexport const triggerSecurityAlert = async (\n  type: '2FA_CHANGE' | 'PASSWORD_RESET',\n  details: {\n    title: string\n    message: string\n    email?: string\n  },\n) => {\n  // 1. Send Push Notification\n  try {\n    await sendPushNotification(\n      details.title,\n      details.message,\n      '/admin/settings',\n    )\n  } catch (e) {\n    console.error('Push notification failed:', e)\n  }\n\n  // 2. Send Email Notification via send-external-notification\n  // We need to fetch the user's email if not provided (usually current user)\n  // For password reset, email is provided. For 2FA, it's current user.\n\n  try {\n    const { error } = await supabase.functions.invoke(\n      'send-external-notification',\n      {\n        body: {\n          title: details.title,\n          message: details.message,\n          type: 'security',\n          link: window.location.origin,\n        },\n      },\n    )\n    if (error) console.error('Email notification failed:', error)\n  } catch (e) {\n    console.error('Email notification exception:', e)\n  }\n}\n"],"mappings":";;AAcA,MAAa,qBAAqB,YAAoC;CACpE,MAAM,EAAE,MAAM,UAAU,MAAM,SAAS,UAAU,OAAO,mBAAmB,EACzE,QAAQ,OACT,CAAC;AAEF,KAAI,MAAO,OAAM;AACjB,QAAO,KAAK,YAAY,EAAE;;AAG5B,MAAa,gBAAgB,OAAO,cAAsB;CACxD,MAAM,EAAE,MAAM,UAAU,MAAM,SAAS,UAAU,OAAO,mBAAmB;EACzE,QAAQ;EACR,MAAM,EAAE,WAAW;EACnB,SAAS,EAER;EAIF,CAAC;CAMF,MAAM,EAAE,MAAM,KAAK,OAAO,gBAAgB,MAAM,SAAS,UAAU,OACjE,iCACA;EACE,QAAQ;EACR,MAAM,EAAE,WAAW;EACpB,CACF;AAED,KAAI,YAAa,OAAM;AACvB,QAAO;;AAIT,MAAa,mBAAmB,OAAO,QAAgB,UAAe,EAAE,KAAK;CAC3E,MAAM,EAAE,UAAU,MAAM,SAAS,IAAI,yBAAyB;EAC5D,aAAa;EACb;EACD,CAAC;AAEF,KAAI,MAAO,SAAQ,MAAM,iCAAiC,MAAM;AAChE,QAAO,EAAE,OAAO;;AAGlB,MAAa,uBAAuB,OAClC,MACA,YAKG;AAEH,KAAI;AACF,QAAM,qBACJ,QAAQ,OACR,QAAQ,SACR,kBACD;UACM,GAAG;AACV,UAAQ,MAAM,6BAA6B,EAAE;;AAO/C,KAAI;EACF,MAAM,EAAE,UAAU,MAAM,SAAS,UAAU,OACzC,8BACA,EACE,MAAM;GACJ,OAAO,QAAQ;GACf,SAAS,QAAQ;GACjB,MAAM;GACN,MAAM,OAAO,SAAS;GACvB,EACF,CACF;AACD,MAAI,MAAO,SAAQ,MAAM,8BAA8B,MAAM;UACtD,GAAG;AACV,UAAQ,MAAM,iCAAiC,EAAE"}